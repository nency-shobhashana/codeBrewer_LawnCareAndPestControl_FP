<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="icon" type="images/png" sizes="32x32" href="images/logo.svg">
	<title>Login</title>
	<!-- CSS file -->
	<link rel="stylesheet" href="css/main.css">
	<link rel="stylesheet" href="css/style.css">
	<link rel="stylesheet" href="css/media.css">

</head>
<body>


<header>
	<div class="header-bar">
		<div class="container">
			<div class="tagline">100% Guarantee Service!!!</div>
			<div class="contact">+1 (647) 758-6542</div>
		</div>
	</div>
	<div class="header-content">
		<div class="container">
			<div class="logo">
				<a href="index.html">
					<img src="images/logo.svg" alt="Lawn care and pest control">
				</a>
			</div>
			<nav>
				<ul>
					<li>
						Services
						<ul>
							<li>
								<a href="lawnCare.html">Lawn Care</a>
								<!-- <ul>
									<li>Fertilization</li>
									<li>Aeration & Seeding</li>
									<li>Trees & Shrubs</li>
								</ul> -->
							</li>
							<li>
								<a href="pestControl.html">Lawn Pest Control</a>
								<!-- <ul>
									<li>Mosquito and Tick Control</li>
									<li>Lawn Insect Control</li>
								</ul> -->
							</li>
						</ul>
					</li>
					<li><a href="serviceArea.html">Service Area</a></li>
					<li><a href="faq.html">FAQ</a></li>
					<li><a href="aboutUs.html">About Us</a></li>
					<li><a href="contactUs.html">Contact Us</a></li>
					<li><a href="myaccount.html">My account</a></li>
					<li><a href="login.html">Login/Resiter</a></li>
				</ul>
			</nav>
		</div>
	</div>
</header>

<main>
	<div class="container">
		<h2 class="text-uppercase color-green font-30">Welcome to a member of Lawn care and Lawn pest control</h2>
		<p>Welcome <b><span id="welcomfname">John</span></b> !!!</p>
		<p>Please have a look on book appoiment and also request for appoinment for our service.</p>
		<div class="user-block">
			<div class="user-profile col-2-3">
				<h3 class="title text-uppercase font-25">User Profile</h3>
				<div class="profile">
					<p><strong>First Name: </strong><span id="fname">John</span></p>
					<p><strong>Last Name: </strong><span id="lname">Smith</span></p>
					<p><strong>Email: </strong><span id="email">john@gmail.com</span></p>
					<p><strong>Phone Number: </strong><span id="phone">647-676-0708</span></p>
					<p><strong>Gender: </strong><span id="gender">Male</span></p>
					<input type="button" value="Logout" onclick="logout()"></button>
				</div>
			</div>
			<div class="appointment col-2-7">
				<h3 class="title text-uppercase font-25">Book your Appointment</h3>
				<form>
					<div class="form-group">
						<input type="text" id="service" name="service" placeholder="Name of Service" required>
					</div>
					<div class="form-group">
						<label><b>Which date do you want to book appoinment?</b></label>
						<input type="date" id="appt_date" name="appt_date" value="2021-03-19" required>
					</div>
					<div class="form-group">
			    	<textarea id="comment" name="comment" placeholder="Enter expected service in detail" rows="6"></textarea>
					</div>
			    <div class="text-center">
			    	<input type="button" value="Book Appointment" onclick="bookAppointment();">
			    </div>
				</form>
				<h3 class="title text-uppercase font-25">Booked Appointment</h3>
				<div id="bookedApptList">
<!--					<div class="bookedAppt-block">-->
<!--						<div><b>Service Name:</b> Pest Control</div>-->
<!--						<div><b>Appoinment date:</b> 2021-03-20</div>-->
<!--						<div><b>Deatil:</b> Backyard and front yard to control mosaquito</div>-->
<!--						<input type="button" value="Cancel Appointment"></button>-->
<!--					</div>-->
				</div>
			</div>
		</div>
	</div>
</main>

<footer>
	<div class="footer">
		<div class="container">
			<div class="footer-section col-3 text-center">
				<img src="images/logo.svg" width="70" class="logo-img">
				<h3 class="text-uppercase font-25">Services</h3>
				<ul>
					<li>Lawn care</li>
					<li>Lawn pest control</li>
				</ul>
			</div>

			<div class="footer-section col-3 text-center">
				<h3 class="title text-uppercase font-25">Our store</h3>
				<h4 class="font-20">Address:</h4>
				<div class="address">Ontario, Canada</div>
				<h4 class="font-20">Opening time:</h4>
				<div class="time">Monday to Saturday (10:00 AM to 6:00 PM)</div>
			</div>
			
			<div class="footer-section col-3 text-center">
				<h3 class="title text-uppercase font-25">Contact Us</h3>
				<h4 class="font-20">E-mail:</h4>
				<div class="email">lawncare@pestcontrol.com</div>
				<h4 class="font-20">Contact Number:</h4>
				<div class="contact">+1 (647) 758-6542</div>
			</div>
		</div>
	</div>
	<div class="footer-copyright text-center">
		<div class="container">
			<h4>&copy; 2021 Nency Shobhashana. All rights reserved.</h4>
		</div>
	</div>
</footer>

<script src="js/script.js"></script>
<script>

	let db;

function init(){
console.log("init called");
window.indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB;
  // DON'T use "var indexedDB = ..." if you're not in a function.
  // Moreover, you may need references to some window.IDB* objects:
  window.IDBTransaction = window.IDBTransaction || window.webkitIDBTransaction || window.msIDBTransaction;
  window.IDBKeyRange = window.IDBKeyRange || window.webkitIDBKeyRange || window.msIDBKeyRange;
  // (Mozilla has never prefixed these objects, so we don't need window.mozIDB*)

  // Let us open our database
  const DBOpenRequest = window.indexedDB.open("LawnCare", 1);

  DBOpenRequest.onsuccess = function(event) {

	console.log("DBOpenRequest.onsuccess done");
    // store the result of opening the database in the db variable. This is used a lot below
    db = DBOpenRequest.result;
	displayUser()
	loadAppointment()
  };

   DBOpenRequest.onerror = function(event) {
		window.location.href = "login.html";
  };

  DBOpenRequest.onupgradeneeded = function(event) {
    console.log("onupgradeneeded start");
    let db = event.target.result;

    var objectStore = db.createObjectStore("user", { keyPath: "email" });

    objectStore.createIndex("fname", "fname", { unique: false });
    objectStore.createIndex("lname", "lname", { unique: false });
    objectStore.createIndex("pwd", "pwd", { unique: false });
    objectStore.createIndex("phone", "phone", { unique: false });
    objectStore.createIndex("birthday", "birthday", { unique: false });
    objectStore.createIndex("birthmonth", "birthmonth", { unique: false });
    objectStore.createIndex("birthyear", "birthyear", { unique: false });
    objectStore.createIndex("gender", "gender", { unique: false });
    objectStore.createIndex("address", "address", { unique: false });

    objectStore = db.createObjectStore("appointment", { keyPath: "id", autoIncrement: true });

	objectStore.createIndex("email", "email", { unique: false });
    objectStore.createIndex("service", "service", { unique: false });
    objectStore.createIndex("date", "date", { unique: false });
    objectStore.createIndex("comment", "comment", { unique: false });

    };
	console.log("init done");
}

window.onload = init

const bookAppointment = () => {
	let formData = {
	email: localStorage.getItem('lawCareCurrentUser'),
	service: document.getElementById('service').value,
	date: document.getElementById('appt_date').value,
    comment: document.getElementById('comment').value,
     }

	let transaction = db.transaction(["appointment"], "readwrite");
	transaction.oncomplete = function() {
		loadAppointment();
		console.log("transaction done");
	};

    let objectStore = transaction.objectStore("appointment");

    // Make a request to add our newItem object to the object store
    objectStore.add(formData);
    console.log("objectStore add done");
}
const loadAppointment = () => {
	let email = localStorage.getItem('lawCareCurrentUser');
	let objectStore = db.transaction('appointment').objectStore("appointment");
	let bookedApptList = document.getElementById('bookedApptList');
	bookedApptList.innerHTML = ""

	var today = new Date();
	var dd = String(today.getDate()).padStart(2, '0');
	var mm = String(today.getMonth() + 1).padStart(2, '0'); //January is 0!
	var yyyy = today.getFullYear();

	today = yyyy + '-' + mm + '-' + dd;

	objectStore.openCursor().onsuccess = function(event) {
	  let cursor = event.target.result;
		// if there is still another cursor to go, keep runing this code

		if(cursor) {
		  if(cursor.value.email == email){
			let bookedApptBlock = document.createElement("div");
			bookedApptBlock.className = "bookedAppt-block";
			let canCancel = cursor.value.date > today
			bookedApptBlock.innerHTML = '<div><b>Service Name:</b> '+cursor.value.service+'</div> '+
						'<div><b>Appoinment date:</b> '+cursor.value.date+'</div>'+
						'<div><b>Deatil:</b> '+cursor.value.comment+'</div>';

			if(canCancel){
				bookedApptBlock.innerHTML = bookedApptBlock.innerHTML + '<input type="button" value="Cancel Appointment" onclick="cancelAppointment('+cursor.value.id+')"></button>'
			}
			bookedApptList.appendChild(bookedApptBlock)
		  }
		  cursor.continue();
		// if there are no more cursor items to iterate through, say so, and exit the function
		} else if(bookedApptList.innerHTML == ""){
			bookedApptList.innerHTML = "<div><b>No Appointment found.</b></div>"
		  console.log("no record found");
		}
	  }
}

const cancelAppointment = id => {
	let transaction = db.transaction(["appointment"], "readwrite");
    let objectStore = transaction.objectStore("appointment");
    let request = objectStore.delete(id);

    transaction.oncomplete = () => { loadAppointment(); };
}
const displayUser = e => {
	let email = localStorage.getItem('lawCareCurrentUser');
	let objectStore = db.transaction('user').objectStore("user");

	objectStore.openCursor().onsuccess = function(event) {
	  let cursor = event.target.result;
		// if there is still another cursor to go, keep runing this code
		if(cursor) {
		  if(cursor.value.email == email){
			document.getElementById('fname').textContent = cursor.value.fname
			document.getElementById('welcomfname').textContent = cursor.value.fname
			document.getElementById('lname').textContent = cursor.value.lname
			document.getElementById('phone').textContent = cursor.value.phone
			document.getElementById('gender').textContent = cursor.value.gender
			document.getElementById('email').textContent = cursor.value.email
			return
		  }
		  cursor.continue();
		// if there are no more cursor items to iterate through, say so, and exit the function
		} else {
		  console.log("user not found");
		  window.location.href = "login.html";
		}
	  }
}

const logout = () =>{
localStorage.setItem('lawCareCurrentUser', '');
window.location.href = "login.html";
}

</script>
</body>
</html>